import * as cdk from 'aws-cdk-lib';
import { Construct } from 'constructs';
import { Duration } from 'aws-cdk-lib';
import * as backup from 'aws-cdk-lib/aws-backup';
import { NamingStackProps } from '../../utils/commonTypes';
import { ResourceNameBuilder } from '../../utils/helpers';

type WccOpsStackProps = {
  namingStackProps: NamingStackProps;
  backupVaultName?: string;
  backupPlanName?: string;
  dailyBackupHour?: number;
  dailyBackupMinute?: number;
  destinationBackupVaultArn: string;
} & cdk.StackProps;

export class WccOpsStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props: WccOpsStackProps) {
    super(scope, id);


    const backupVault = new backup.BackupVault(this, 'MyBackupVault', {
      backupVaultName: ResourceNameBuilder.makeResourceNameStr({
        serviceName: 'backup',
        use: `tokyovault`,
        ...props.namingStackProps,
      }),
    });

const commonCopyAction: backup.CfnBackupPlan.CopyActionResourceTypeProperty = {
  destinationBackupVaultArn: props.destinationBackupVaultArn,
  lifecycle: {
    deleteAfterDays: 20,
  },
};



const backupPlanec2windows = new backup.CfnBackupPlan(this, 'plan1', {
  backupPlan: {
    backupPlanName: ResourceNameBuilder.makeResourceNameStr({
      serviceName: 'backup',
      use: `ec2windowsplan`,
      ...props.namingStackProps,
    }),
    backupPlanRule: [
      {
        ruleName: ResourceNameBuilder.makeResourceNameStr({
          serviceName: 'rule',
          use: `ec2rule`,
          ...props.namingStackProps,
        }),
        scheduleExpression: 'cron(0 15 * * ? *)',
        startWindowMinutes: Duration.hours(1).toMinutes(),
        completionWindowMinutes: Duration.hours(6).toMinutes(),
        lifecycle: {
          deleteAfterDays: 20,
        },
        copyActions: [commonCopyAction],
        targetBackupVault: backupVault.backupVaultName,
      } as backup.CfnBackupPlan.BackupRuleResourceTypeProperty,
    ],
    advancedBackupSettings: [
      {
        backupOptions: {
          'WindowsVSS': 'enabled',
        },
        resourceType: 'EC2',
      },
    ],
  },
});



const backupPlanec2linux = new backup.CfnBackupPlan(this, 'plan2', {
  backupPlan: {
    backupPlanName: ResourceNameBuilder.makeResourceNameStr({
      serviceName: 'backup',
      use: `ec2linuxplan`,
      ...props.namingStackProps,
    }),
    backupPlanRule: [
      {
        ruleName: ResourceNameBuilder.makeResourceNameStr({
          serviceName: 'rule',
          use: `ec2rule`,
          ...props.namingStackProps,
        }),
        scheduleExpression: 'cron(0 15 * * ? *)',
        startWindowMinutes: Duration.hours(1).toMinutes(),
        completionWindowMinutes: Duration.hours(6).toMinutes(),
        lifecycle: {
          deleteAfterDays: 20,
        },
        copyActions: [commonCopyAction],
        targetBackupVault: backupVault.backupVaultName,
      } as backup.CfnBackupPlan.BackupRuleResourceTypeProperty,
    ],
  },
});


     new backup.CfnBackupSelection(this, 'WindowsBackupSelection', {
      backupPlanId: backupPlanec2windows.ref,
      backupSelection: {
        selectionName: 'ec2-windows',
        iamRoleArn: `arn:aws:iam::${cdk.Stack.of(this).account}:role/service-role/AWSBackupDefaultServiceRole`, // Default role ARN
        resources: [
          `arn:aws:ec2:*:*:instance/*`,
        ],
        listOfTags: [
          {
            conditionType: 'STRINGEQUALS',
            conditionKey: 'Name',
            conditionValue: 'cpi-ec2-ps-dev-iwel-01',
          },
        ],
      },
    });

    new backup.CfnBackupSelection(this, 'LinuxBackupSelection', {
      backupPlanId: backupPlanec2linux.ref,
      backupSelection: {
        selectionName: 'ec2-linux',
        iamRoleArn: `arn:aws:iam::${cdk.Stack.of(this).account}:role/service-role/AWSBackupDefaultServiceRole`,
        resources: [`arn:aws:ec2:*:*:instance/*`],
        listOfTags: [
          {
            conditionType: 'STRINGEQUALS',
            conditionKey: 'Name',
            conditionValue: 'cpi-ec2-ps-dev-iwel-02',
          },
        ],
      },
    });
    
    
    
      // Add a new backup plan for FSx for Windows
    const backupPlanFSxWindows = new backup.CfnBackupPlan(this, 'FSxWindowsBackupPlan', {
      backupPlan: {
        backupPlanName: ResourceNameBuilder.makeResourceNameStr({
          serviceName: 'backup',
          use: `fsxwindows`,
          ...props.namingStackProps,
        }),
        backupPlanRule: [
          {
            ruleName: ResourceNameBuilder.makeResourceNameStr({
              serviceName: 'rule',
              use: `fsxwindowsrule`,
              ...props.namingStackProps,
            }),
            scheduleExpression: 'cron(0 15 * * ? *)',
            startWindowMinutes: Duration.hours(1).toMinutes(),
            completionWindowMinutes: Duration.hours(6).toMinutes(),
            lifecycle: {
              deleteAfterDays: 20,
            },
            copyActions: [commonCopyAction],
            targetBackupVault: backupVault.backupVaultName,
          } as backup.CfnBackupPlan.BackupRuleResourceTypeProperty,
        ],
      },
    });

    // Add a new backup selection for FSx for Windows
    new backup.CfnBackupSelection(this, 'FSxWindowsBackupSelection', {
      backupPlanId: backupPlanFSxWindows.ref,
      backupSelection: {
        selectionName: 'fsx-windows',
        iamRoleArn: `arn:aws:iam::${cdk.Stack.of(this).account}:role/service-role/AWSBackupDefaultServiceRole`,
        resources: [`arn:aws:fsx:*:*:file-system/*`],
        listOfTags: [
          {
            conditionType: 'STRINGEQUALS',
            conditionKey: 'Name',
            conditionValue: 'cpi-fsx-ps-dev-windows', // Change this to the appropriate value for your FSx for Windows resource
          },
        ],
      },
    });  
  }
}

